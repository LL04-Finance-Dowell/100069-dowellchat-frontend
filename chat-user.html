<!doctype html>
<html lang="en">

<head>
  <title>Dowell User Side</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS v5.2.0-beta1 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
    integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">

</head>

<body>

  <main>

        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-4">
                    <div class="card text-center mt-5">
                        <div class="card-header">
                            <h4 id="room_name_head">Chat with Us</h4>
                        </div>
                        <div class="card-body">
                            <form id="userChatForm" method="POST">
                                <div class="input-group mt-5 mb-4">
                                    <input name="user_name" type="text" class="form-control" placeholder="Enter your Name" id="user_name"> 
                                </div>
                                <button type="submit" class="btn btn-primary" id="userChatBtn">Chat</button>
                            </form>
                        </div>
                    </div>
                </div>
               
            </div>
        </div>
  </main>
  <footer>
    <!-- place footer here -->
  </footer>
  <!-- Bootstrap JavaScript Libraries -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
    integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous">
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"
    integrity="sha384-ODmDIVzN+pFdexxHEHFBQH3/9/vQ9uori45z4JjnFsRydbmQbmL5t1tQ0culUzyK" crossorigin="anonymous">
  </script> -->

  <!-- add jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>


<script>
const userChatBtn = document.querySelector('#userChatBtn');

if (userChatBtn){
    userChatBtn.addEventListener('click',linkBasedLogin)
}
else{
    console.log('userChatBtn not found');
}



function linkBasedLogin(){
    event.preventDefault();
    const formData = new FormData(document.getElementById('userChatForm'));
    //console.log(formData);
    //convert to json
    const formdata = Object.fromEntries(formData.entries());
    console.log(formdata);

    const user_name = formdata['user_name'];
    localStorage.setItem('user_name',user_name);
    //dont send empty names
    if (user_name === ''){
        return false;
    }

    //const user_name ='Bickky'
    const os = 'osver';
    const device = 'device';
    const browser = 'brow';
    const location = 'loc';
    const time='str(ltime)';
    const connection = 'mobconn';
    const ip = 'ipuser';
    const data = {
            'Username':user_name,
            'OS':os,
            'Device': device,
            'Browser': browser,
            'Location': location,
            'Time': time,
            'Connection': connection,
            'IP': ip,
        };
    console.log(data);

    $.ajax({
        url:'https://100014.pythonanywhere.com/api/linkbased/',
        type:'POST',
        data:data,
        
        success: function (data) {
            console.log(data);
            //call create room api
        
            const newdata = {
                "user_name":user_name,
                "qrid":data['qrid'],
            }
            createRoom(newdata);
        },
        error: function (data) {
            console.log(data);
        }
    })
}

function createRoom(data){

    console.log("calling create room api");
    $.ajax({
        url: 'https://100069.pythonanywhere.com/chat/create-room/',
        type: 'POST',
        data: {
            'user_name': data['user_name'],
            'qrid': data['qrid']
        },
        success: function (data) {
            document.querySelector('#user_name').value = '';
            console.log(data);
            console.log(data['room_name']);
            //save data in request.session
            localStorage.setItem('room',data['room_name'])
            //redirect to chat.html page in the same directory
            window.location.href = 'chat.html';
            // window.location.href = 'https://github.com/LL04-Finance-Dowell/100069-dowellchat-frontend/chat.html';
            
        },
        error: function (data) {
            console.log(data);
        }
    })
}


</script>

</body>


</html>